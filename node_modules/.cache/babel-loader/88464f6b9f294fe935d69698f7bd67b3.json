{"ast":null,"code":"import _regeneratorRuntime from\"/Users/haesol/Desktop/mediround-user-web-master/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/haesol/Desktop/mediround-user-web-master/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/haesol/Desktop/mediround-user-web-master/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect}from\"react\";import UserPool,{getUser,toUserPoolAttr}from\"../aws/UserPool\";import Button from\"../components/Button/Button\";import InfoInput from\"../components/Input/InfoInput\";import{useAuthContext}from\"../auth/auth\";import\"./SignUp.scss\";import{phoneLocaleList}from\"../utils\";import CheckBox from\"../components/Input/CheckBox\";import{postUser}from\"../api/user\";import{FormattedMessage}from\"react-intl\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export var SignUpForm=function SignUpForm(props){var auth=useAuthContext();var _useState=useState(\"\"),_useState2=_slicedToArray(_useState,2),name=_useState2[0],setName=_useState2[1];var _useState3=useState(\"\"),_useState4=_slicedToArray(_useState3,2),email=_useState4[0],setEmail=_useState4[1];var _useState5=useState(\"\"),_useState6=_slicedToArray(_useState5,2),phone=_useState6[0],setPhone=_useState6[1];var _useState7=useState(phoneLocaleList[0].value),_useState8=_slicedToArray(_useState7,2),phoneLocale=_useState8[0],setPhoneLocale=_useState8[1];var _useState9=useState(\"\"),_useState10=_slicedToArray(_useState9,2),phoneDigit=_useState10[0],setPhoneDigit=_useState10[1];var _useState11=useState(\"\"),_useState12=_slicedToArray(_useState11,2),cachedPhone=_useState12[0],setCachedPhone=_useState12[1];var _useState13=useState(\"\"),_useState14=_slicedToArray(_useState13,2),code=_useState14[0],setCode=_useState14[1];var _useState15=useState(\"\"),_useState16=_slicedToArray(_useState15,2),password=_useState16[0],setPassword=_useState16[1];var _useState17=useState(\"\"),_useState18=_slicedToArray(_useState17,2),rePassword=_useState18[0],setRePassword=_useState18[1];var _useState19=useState(false),_useState20=_slicedToArray(_useState19,2),isConfirmed=_useState20[0],setIsConfirmed=_useState20[1];var _useState21=useState(false),_useState22=_slicedToArray(_useState21,2),isCodeSent=_useState22[0],setIsCodeSent=_useState22[1];var _useState23=useState(false),_useState24=_slicedToArray(_useState23,2),codeRecvInProgress=_useState24[0],setCodeRecvInProgress=_useState24[1];var _useState25=useState(false),_useState26=_slicedToArray(_useState25,2),isConfirmCodeInProgress=_useState26[0],setIsConfirmCodeInProgress=_useState26[1];var _useState27=useState(false),_useState28=_slicedToArray(_useState27,2),isAgreed=_useState28[0],setIsAgreed=_useState28[1];useEffect(function(){// Decides when submit button should become available\nif(isConfirmed&&isAgreed){props.setSubmitReady(true);}else{props.setSubmitReady(false);}});useEffect(function(){// Determines phone number i.e. username\nvar fullPhone=phoneLocale+phoneDigit;setPhone(fullPhone);},[phoneLocale,phoneDigit]);var isReadyToSignUp=function isReadyToSignUp(){return name.trim()!==\"\"&&email.trim()!==\"\"&&phone.trim()!==\"\"&&password===rePassword;};var signUpHandler=function signUpHandler(){var trimmedEmail=email.trim();var trimmedPhone=phone.trim();var trimmedName=name.trim();setCodeRecvInProgress(true);var emailAttr=toUserPoolAttr(\"email\",trimmedEmail);var phoneAttr=toUserPoolAttr(\"phone_number\",trimmedPhone);UserPool.signUp(trimmedPhone,password,[emailAttr,phoneAttr],[],/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(err,result){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!err){_context.next=4;break;}console.log(\"Error\",err);_context.next=12;break;case 4:console.log(\"Success\",result);setCachedPhone(trimmedPhone);setPhone(trimmedPhone);setEmail(trimmedEmail);setName(trimmedName);// TODO: show error modal when failed\n_context.next=11;return postUser({sub:result.userSub,phone:trimmedPhone,email:trimmedEmail,name:trimmedName});case 11:setIsCodeSent(true);case 12:setCodeRecvInProgress(false);case 13:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2){return _ref.apply(this,arguments);};}());};var resendCodeHandler=function resendCodeHandler(){setCodeRecvInProgress(true);var congitoUser=getUser(cachedPhone);congitoUser.resendConfirmationCode(function(err){if(err){console.error(err);}else{setCodeRecvInProgress(false);}});};var confirmCodeHandler=function confirmCodeHandler(){setIsConfirmCodeInProgress(true);var cognitoUser=getUser(phone);cognitoUser.confirmRegistration(code,false,function(err,data){if(err){console.error(err);setIsConfirmCodeInProgress(false);}else{auth===null||auth===void 0?void 0:auth.authenticate(phone,password).then(function(res){console.log(\"Authenticated!\",res);setIsConfirmed(true);}).catch(function(err){console.error(\"Failed to authenticate!\",err);}).finally(function(){setIsConfirmCodeInProgress(false);});}});};return/*#__PURE__*/_jsxs(\"div\",{className:\"signup-form-container\",children:[/*#__PURE__*/_jsx(InfoInput,{title:\"Name\",titleId:\"signUp.name\",value:name,onChange:function onChange(e){return setName(e.target.value);}}),/*#__PURE__*/_jsx(InfoInput,{title:\"Email\",titleId:\"signUp.email\",type:\"email\",value:email,onChange:function onChange(e){return setEmail(e.target.value);}}),/*#__PURE__*/_jsx(InfoInput,{title:\"Password (at least 8 characters)\",titleId:\"signUp.password\",type:\"password\",value:password,onChange:function onChange(e){return setPassword(e.target.value);}}),/*#__PURE__*/_jsx(InfoInput,{title:\"Re-enter password\",titleId:\"signUp.reEnterPassword\",type:\"password\",value:rePassword,onChange:function onChange(e){return setRePassword(e.target.value);}}),/*#__PURE__*/_jsx(InfoInput,{title:\"Phone number\",titleId:\"signUp.phoneNumber\",type:\"tel\",value:phoneDigit,onChange:function onChange(e){return setPhoneDigit(e.target.value);},buttonText:isCodeSent&&phone===cachedPhone?\"재전송\":\"코드 전송\",buttonTextId:isCodeSent&&phone===cachedPhone?\"button.reSend\":\"button.sendCode\",buttonDisabled:!isReadyToSignUp(),onButtonClick:isCodeSent&&phone===cachedPhone?resendCodeHandler:signUpHandler,buttonLoading:codeRecvInProgress,optionVals:phoneLocaleList.map(function(obj){return obj.value;}),optionKeys:phoneLocaleList.map(function(obj){return obj.icon+\" \"+obj.value;}),onSelectChange:function onSelectChange(e){return setPhoneLocale(e.target.value);}}),isCodeSent&&/*#__PURE__*/_jsx(InfoInput,{title:\"Code\",value:code,onChange:function onChange(e){return setCode(e.target.value);},buttonText:isConfirmed?\"\":\"확인\",onButtonClick:confirmCodeHandler,buttonDisabled:!isReadyToSignUp()||code===\"\",disabled:isConfirmed,width:\"calc(100% - 144px)\",buttonLoading:isConfirmCodeInProgress,showConfirmed:isConfirmed}),/*#__PURE__*/_jsxs(\"div\",{className:\"signup-term-agree-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"signup-term-checkbox-container\",children:/*#__PURE__*/_jsx(CheckBox,{value:isAgreed,onChange:function onChange(){return setIsAgreed(!isAgreed);}})}),/*#__PURE__*/_jsx(FormattedMessage,{id:\"signUp.privacy\"})]})]});};var SignUp=function SignUp(props){var _useState29=useState(false),_useState30=_slicedToArray(_useState29,2),isSignUpReady=_useState30[0],setIsSignUpReady=_useState30[1];return/*#__PURE__*/_jsxs(\"div\",{className:\"signup-page-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"signup-page-title\",children:/*#__PURE__*/_jsx(FormattedMessage,{id:\"signUp.user\"})}),/*#__PURE__*/_jsx(SignUpForm,{setSubmitReady:setIsSignUpReady}),/*#__PURE__*/_jsx(\"div\",{className:\"signup-footer-container\",children:/*#__PURE__*/_jsx(Button,{text:\"Sign Up\",textId:\"button.signUp\",theme:\"primary\",shape:\"round\",isDisabled:!isSignUpReady,onClick:function onClick(){return props.history.push(\"/landing\");}})})]});};export default SignUp;","map":{"version":3,"sources":["/Users/haesol/Desktop/mediround-user-web-master/src/pages/SignUp.tsx"],"names":["React","useState","useEffect","UserPool","getUser","toUserPoolAttr","Button","InfoInput","useAuthContext","phoneLocaleList","CheckBox","postUser","FormattedMessage","SignUpForm","props","auth","name","setName","email","setEmail","phone","setPhone","value","phoneLocale","setPhoneLocale","phoneDigit","setPhoneDigit","cachedPhone","setCachedPhone","code","setCode","password","setPassword","rePassword","setRePassword","isConfirmed","setIsConfirmed","isCodeSent","setIsCodeSent","codeRecvInProgress","setCodeRecvInProgress","isConfirmCodeInProgress","setIsConfirmCodeInProgress","isAgreed","setIsAgreed","setSubmitReady","fullPhone","isReadyToSignUp","trim","signUpHandler","trimmedEmail","trimmedPhone","trimmedName","emailAttr","phoneAttr","signUp","err","result","console","log","sub","userSub","resendCodeHandler","congitoUser","resendConfirmationCode","error","confirmCodeHandler","cognitoUser","confirmRegistration","data","authenticate","then","res","catch","finally","e","target","map","obj","icon","SignUp","isSignUpReady","setIsSignUpReady","history","push"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport UserPool, { getUser, toUserPoolAttr } from \"../aws/UserPool\";\nimport Button from \"../components/Button/Button\";\nimport InfoInput from \"../components/Input/InfoInput\";\nimport { useAuthContext } from \"../auth/auth\";\nimport \"./SignUp.scss\";\nimport { phoneLocaleList } from \"../utils\";\nimport { RouteComponentProps } from \"react-router\";\nimport CheckBox from \"../components/Input/CheckBox\";\nimport { postUser } from \"../api/user\";\nimport { FormattedMessage } from \"react-intl\";\n\ninterface FormProps {\n  setSubmitReady: React.Dispatch<React.SetStateAction<boolean>>;\n}\n\nexport const SignUpForm = (props: FormProps) => {\n  const auth = useAuthContext();\n  const [name, setName] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [phone, setPhone] = useState(\"\");\n  const [phoneLocale, setPhoneLocale] = useState(phoneLocaleList[0].value);\n  const [phoneDigit, setPhoneDigit] = useState(\"\");\n  const [cachedPhone, setCachedPhone] = useState(\"\");\n  const [code, setCode] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [rePassword, setRePassword] = useState(\"\");\n  const [isConfirmed, setIsConfirmed] = useState(false);\n  const [isCodeSent, setIsCodeSent] = useState(false);\n  const [codeRecvInProgress, setCodeRecvInProgress] = useState(false);\n  const [isConfirmCodeInProgress, setIsConfirmCodeInProgress] = useState(false);\n  const [isAgreed, setIsAgreed] = useState(false);\n\n  useEffect(() => {\n    // Decides when submit button should become available\n    if (isConfirmed && isAgreed) {\n      props.setSubmitReady(true);\n    } else {\n      props.setSubmitReady(false);\n    }\n  });\n\n  useEffect(() => {\n    // Determines phone number i.e. username\n    const fullPhone = phoneLocale + phoneDigit;\n    setPhone(fullPhone);\n  }, [phoneLocale, phoneDigit]);\n\n  const isReadyToSignUp = () => {\n    return (\n      name.trim() !== \"\" &&\n      email.trim() !== \"\" &&\n      phone.trim() !== \"\" &&\n      password === rePassword\n    );\n  };\n  const signUpHandler = () => {\n    const trimmedEmail = email.trim();\n    const trimmedPhone = phone.trim();\n    const trimmedName = name.trim();\n    setCodeRecvInProgress(true);\n    const emailAttr = toUserPoolAttr(\"email\", trimmedEmail);\n    const phoneAttr = toUserPoolAttr(\"phone_number\", trimmedPhone);\n    UserPool.signUp(\n      trimmedPhone,\n      password,\n      [emailAttr, phoneAttr],\n      [],\n      async (err, result) => {\n        if (err) {\n          console.log(\"Error\", err);\n        } else {\n          console.log(\"Success\", result);\n          setCachedPhone(trimmedPhone);\n          setPhone(trimmedPhone);\n          setEmail(trimmedEmail);\n          setName(trimmedName);\n          // TODO: show error modal when failed\n          await postUser({\n            sub: result!.userSub,\n            phone: trimmedPhone,\n            email: trimmedEmail,\n            name: trimmedName,\n          });\n          setIsCodeSent(true);\n        }\n        setCodeRecvInProgress(false);\n      },\n    );\n  };\n\n  const resendCodeHandler = () => {\n    setCodeRecvInProgress(true);\n    const congitoUser = getUser(cachedPhone);\n    congitoUser.resendConfirmationCode((err) => {\n      if (err) {\n        console.error(err);\n      } else {\n        setCodeRecvInProgress(false);\n      }\n    });\n  };\n\n  const confirmCodeHandler = () => {\n    setIsConfirmCodeInProgress(true);\n    const cognitoUser = getUser(phone);\n    cognitoUser.confirmRegistration(code, false, (err, data) => {\n      if (err) {\n        console.error(err);\n        setIsConfirmCodeInProgress(false);\n      } else {\n        auth\n          ?.authenticate(phone, password)\n          .then((res) => {\n            console.log(\"Authenticated!\", res);\n            setIsConfirmed(true);\n          })\n          .catch((err) => {\n            console.error(\"Failed to authenticate!\", err);\n          })\n          .finally(() => {\n            setIsConfirmCodeInProgress(false);\n          });\n      }\n    });\n  };\n\n  return (\n    <div className=\"signup-form-container\">\n      <InfoInput\n        title=\"Name\"\n        titleId=\"signUp.name\"\n        value={name}\n        onChange={(e) => setName(e.target.value)}\n      />\n      <InfoInput\n        title=\"Email\"\n        titleId=\"signUp.email\"\n        type=\"email\"\n        value={email}\n        onChange={(e) => setEmail(e.target.value)}\n      />\n      <InfoInput\n        title=\"Password (at least 8 characters)\"\n        titleId=\"signUp.password\"\n        type=\"password\"\n        value={password}\n        onChange={(e) => setPassword(e.target.value)}\n      />\n      <InfoInput\n        title=\"Re-enter password\"\n        titleId=\"signUp.reEnterPassword\"\n        type=\"password\"\n        value={rePassword}\n        onChange={(e) => setRePassword(e.target.value)}\n      />\n      <InfoInput\n        title=\"Phone number\"\n        titleId=\"signUp.phoneNumber\"\n        type=\"tel\"\n        value={phoneDigit}\n        onChange={(e) => setPhoneDigit(e.target.value)}\n        buttonText={\n          isCodeSent && phone === cachedPhone ? \"재전송\" : \"코드 전송\"\n        }\n        buttonTextId={\n          isCodeSent && phone === cachedPhone\n            ? \"button.reSend\"\n            : \"button.sendCode\"\n        }\n        buttonDisabled={!isReadyToSignUp()}\n        onButtonClick={\n          isCodeSent && phone === cachedPhone\n            ? resendCodeHandler\n            : signUpHandler\n        }\n        buttonLoading={codeRecvInProgress}\n        optionVals={phoneLocaleList.map((obj) => obj.value)}\n        optionKeys={phoneLocaleList.map((obj) => obj.icon + \" \" + obj.value)}\n        onSelectChange={(e) => setPhoneLocale(e.target.value)}\n      />\n      {isCodeSent && (\n        <InfoInput\n          title=\"Code\"\n          value={code}\n          onChange={(e) => setCode(e.target.value)}\n          buttonText={isConfirmed ? \"\" : \"확인\"}\n          onButtonClick={confirmCodeHandler}\n          buttonDisabled={!isReadyToSignUp() || code === \"\"}\n          disabled={isConfirmed}\n          width=\"calc(100% - 144px)\"\n          buttonLoading={isConfirmCodeInProgress}\n          showConfirmed={isConfirmed}\n        />\n      )}\n      <div className=\"signup-term-agree-container\">\n        <div className=\"signup-term-checkbox-container\">\n          <CheckBox value={isAgreed} onChange={() => setIsAgreed(!isAgreed)} />\n        </div>\n        <FormattedMessage id=\"signUp.privacy\" />\n      </div>\n    </div>\n  );\n};\n\nconst SignUp = (props: RouteComponentProps) => {\n  const [isSignUpReady, setIsSignUpReady] = useState(false);\n  return (\n    <div className=\"signup-page-container\">\n      <div className=\"signup-page-title\">\n        <FormattedMessage id=\"signUp.user\" />\n      </div>\n      <SignUpForm setSubmitReady={setIsSignUpReady} />\n      <div className=\"signup-footer-container\">\n        <Button\n          text=\"Sign Up\"\n          textId=\"button.signUp\"\n          theme=\"primary\"\n          shape=\"round\"\n          isDisabled={!isSignUpReady}\n          onClick={() => props.history.push(\"/landing\")}\n        />\n      </div>\n    </div>\n  );\n};\n\nexport default SignUp;\n"]},"metadata":{},"sourceType":"module"}